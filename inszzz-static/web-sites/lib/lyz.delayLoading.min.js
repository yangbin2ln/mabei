/*
 * Summary: lyz.delayLoading 1.0 Author: ����־ Date: 2011 Emial: c_sharp@live.cn
 */
jQuery.fn.extend({
	delayLoading : function(a) {
		function g(d) {
			var b, c;
			var win = $(window);
			var ac = $(a.container);
			if (a.container === undefined || a.container === window) {
				b = win.scrollTop();
				c = win.height() + win.scrollTop()
			} else {
				b = ac.offset().top;
				c = ac.offset().top + ac.height()
			}
			return d.offset().top + d.height() + a.beforehand >= b
					&& c >= d.offset().top - a.beforehand
		}
		function h(d) {
			var b, c;
			var win = $(window);
			var ac = $(a.container);
			if (a.container === undefined || a.container === window) {
				b = win.scrollLeft();
				c = win.width() + win.scrollLeft()
			} else {
				b = ac.offset().left;
				c = ac.offset().left + ac.width()
			}
			return d.offset().left + d.width() + a.beforehand >= b
					&& c >= d.offset().left - a.beforehand
		}
		function f() {
			e.filter("*[" + a.imgSrcAttr + "]").each(function(d, b) {
				var me = $(b);
				if (me.attr(a.imgSrcAttr) !== undefined
						&& me.attr(a.imgSrcAttr) !== null
						&& me.attr(a.imgSrcAttr) !== "" && g(me) && h(me)) {
					var c = new Image;
					
					c.onload = function() {
						if (me.is('img')) {
							me.attr("src", c.src);
						}else{
							me.css('background-image','url('+c.src+')');
						}
						a.duration !== 0 && me.hide().fadeIn(a.duration);
						me.removeAttr(a.imgSrcAttr);
						a.success(me)
					};
					c.onerror = function() {
						if (me.is('img')) {
							me.attr("src", a.errorImg);
						}else{
							me.css('background-image','url('+a.errorImg+')');
						}
						me.removeAttr(a.imgSrcAttr);
						a.error(me)
					};
					c.src = me.attr(a.imgSrcAttr);
				}
			})
		}
		a = jQuery.extend({
					defaultImg : "",
					errorImg : "",
					imgSrcAttr : "originalSrc",
					beforehand : 0,
					event : "scroll",
					duration : "normal",
					container : window,
					success : function() {
					},
					error : function() {
					}
				}, a || {});
		if (a.errorImg === undefined || a.errorImg === null
				|| a.errorImg === "")
			a.errorImg = a.defaultImg;
			
		var e = $(this);
		var o;
		e.each(function(i,obj){
			var o = $(obj);
			//如果是img标签
			if (o.is('img')) {
				if (o.attr("src") === undefined || o.attr("src") === null|| o.attr("src") === ""){
					o.attr("src", a.defaultImg);
				}
			}else{
				//非img标签处理background-image
				o.css('background-image','url('+a.defaultImg+')');
			}
		});
		f();
		$(a.container).bind(a.event, function() {f()})
	}
});
